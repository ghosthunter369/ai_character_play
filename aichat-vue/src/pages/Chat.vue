<template>
  <div class="chat-page">
    <el-container class="chat-container">
      <!-- ‰æßËæπÊ†è -->
      <el-aside class="chat-sidebar" width="320px">
        <div class="sidebar-header">
          <div class="header-title">
            <el-icon size="24"><ChatDotRound /></el-icon>
            <h3>AI ËÅäÂ§©Âä©Êâã</h3>
          </div>
          <el-button type="primary" @click="showCreateModal = true" circle>
            <el-icon><Plus /></el-icon>
          </el-button>
        </div>
        
        <!-- ÂΩìÂâçÈÄâ‰∏≠ÁöÑAPP‰ø°ÊÅØ -->
        <div v-if="selectedApp" class="current-app-info">
          <div class="current-app-card">
            <el-avatar :size="48" :src="selectedApp.cover" class="current-app-avatar">
              <el-icon><Avatar /></el-icon>
            </el-avatar>
            <div class="current-app-details">
              <h4 class="current-app-name">{{ selectedApp.appName }}</h4>
              <p class="current-app-desc">{{ selectedApp.description || 'ÊöÇÊó†ÊèèËø∞' }}</p>
              <div class="app-meta">
                <el-tag size="small" type="success">{{ selectedApp.userName || 'Á≥ªÁªü' }}</el-tag>
                <span class="create-time">{{ formatTime(selectedApp.createTime) }}</span>
              </div>
            </div>
          </div>
          <div class="welcome-message">
            <el-icon class="welcome-icon"><Promotion /></el-icon>
            <p>Ê¨¢Ëøé‰ΩøÁî® {{ selectedApp.appName }}ÔºÅÊàëÊòØÊÇ®ÁöÑAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÂä©ÊÇ®ÁöÑÂêóÔºü</p>
          </div>
        </div>
        
        <div class="app-list">
          <div
            v-for="app in apps"
            :key="app.appId"
            :class="['app-item', { active: selectedApp?.appId === app.appId }]"
            @click="selectApp(app)"
          >
            <el-avatar :size="40" :src="app.cover" class="app-avatar">
              <el-icon><Avatar /></el-icon>
            </el-avatar>
            <div class="app-info">
              <h4 class="app-name">{{ app.appName }}</h4>
              <p class="app-desc">{{ app.description || 'ÊöÇÊó†ÊèèËø∞' }}</p>
            </div>
            <el-badge v-if="getUnreadCount(app.appId)" :value="getUnreadCount(app.appId)" class="unread-badge" />
          </div>
        </div>
      </el-aside>

      <!-- ‰∏ªËÅäÂ§©Âå∫Âüü -->
      <el-main class="chat-main">
        <div v-if="selectedApp" class="chat-content">
          <!-- ËÅäÂ§©Â§¥ÈÉ® -->
          <div class="chat-header">
            <div class="header-left">
              <el-avatar :size="36" :src="selectedApp.cover">
                <el-icon><Avatar /></el-icon>
              </el-avatar>
              <div class="app-details">
                <h3>{{ selectedApp.appName }}</h3>
                <p>{{ selectedApp.description }}</p>
              </div>
            </div>
            
            <div class="header-right">
              <el-dropdown @command="handleMenuCommand">
                <el-button circle>
                  <el-icon><MoreFilled /></el-icon>
                </el-button>
                <template #dropdown>
                  <el-dropdown-menu>
                    <el-dropdown-item command="clear">Ê∏ÖÁ©∫ÂØπËØù</el-dropdown-item>
                    <el-dropdown-item command="export">ÂØºÂá∫ÂØπËØù</el-dropdown-item>
                    <el-dropdown-item command="settings">ËÆæÁΩÆ</el-dropdown-item>
                  </el-dropdown-menu>
                </template>
              </el-dropdown>
            </div>
          </div>

          <!-- ËÅäÂ§©Ê®°ÂºèÊ†áÁ≠æÈ°µ -->
          <div class="chat-tabs">
            <div class="tabs-container">
              <button 
                class="tab-button"
                :class="{ active: chatMode === 'text' }"
                @click="chatMode = 'text'"
              >
                <el-icon><ChatDotRound /></el-icon>
                <span>ÊñáÂ≠óËÅäÂ§©</span>
              </button>
              <button 
                class="tab-button"
                :class="{ active: chatMode === 'voice' }"
                @click="chatMode = 'voice'"
              >
                <el-icon><Microphone /></el-icon>
                <span>ËØ≠Èü≥ËÅäÂ§©</span>
              </button>
            </div>
          </div>

          <!-- Ê†áÁ≠æÈ°µÂÜÖÂÆπÂå∫Âüü -->
          <div class="tab-content-area">
            <!-- ÊñáÂ≠óËÅäÂ§©Ê†áÁ≠æÈ°µ -->
            <div v-show="chatMode === 'text'" class="tab-content text-chat-tab">
              <!-- Ê∂àÊÅØÂàóË°® -->
              <div class="messages-container" ref="messagesContainer">
                <div class="messages-list">
                  <!-- Ê¨¢ËøéÊ∂àÊÅØ -->
                  <div v-if="messages.length === 0 && selectedApp.prologue" class="welcome-message">
                    <div class="message-bubble ai-message">
                      <el-avatar :size="32" :src="selectedApp.cover" class="message-avatar">
                        <el-icon><Avatar /></el-icon>
                      </el-avatar>
                      <div class="bubble-content">
                        <div class="message-text">{{ selectedApp.prologue }}</div>
                        <div class="message-time">{{ formatTime(new Date()) }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- ÂéÜÂè≤Ê∂àÊÅØ -->
                  <div
                    v-for="message in messages"
                    :key="message.id"
                    :class="['message-item', message.type]"
                  >
                    <div :class="['message-bubble', `${message.type}-message`]">
                      <el-avatar 
                        v-if="message.type === 'ai'" 
                        :size="32" 
                        :src="selectedApp.cover" 
                        class="message-avatar"
                      >
                        <el-icon><Avatar /></el-icon>
                      </el-avatar>
                      
                      <div class="bubble-content">
                        <div class="message-text" v-html="formatMessageContent(message.content)"></div>
                        <div class="message-time">{{ formatTime(message.timestamp) }}</div>
                      </div>
                      
                      <el-avatar 
                        v-if="message.type === 'user'" 
                        :size="32" 
                        :src="userStore.user?.userAvatar" 
                        class="message-avatar"
                      >
                        <el-icon><User /></el-icon>
                      </el-avatar>
                    </div>
                  </div>

                  <!-- ÊµÅÂºèÂìçÂ∫îÊ∂àÊÅØ -->
                  <div v-if="streamingContent" class="message-item ai">
                    <div class="message-bubble ai-message streaming">
                      <el-avatar :size="32" :src="selectedApp.cover" class="message-avatar">
                        <el-icon><Avatar /></el-icon>
                      </el-avatar>
                      <div class="bubble-content">
                        <div class="message-text">{{ streamingContent }}</div>
                        <div class="typing-indicator">
                          <span></span>
                          <span></span>
                          <span></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ÊñáÂ≠óËæìÂÖ•Âå∫Âüü -->
              <div class="text-input-area">
                <div class="input-container">
                  <el-input
                    v-model="inputMessage"
                    type="textarea"
                    :rows="1"
                    :autosize="{ minRows: 1, maxRows: 4 }"
                    placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                    @keydown.enter.exact.prevent="sendMessage"
                    @keydown.enter.shift.exact="handleShiftEnter"
                    :disabled="isStreaming"
                    class="message-input"
                  />
                  <div class="input-actions">
                    <el-button
                      @click="toggleVoiceInput"
                      :type="isVoiceInputMode ? 'danger' : 'default'"
                      circle
                      class="voice-toggle-btn"
                    >
                      <el-icon><Microphone /></el-icon>
                    </el-button>
                    <el-button
                      type="primary"
                      @click="sendMessage"
                      :loading="isStreaming"
                      :disabled="!inputMessage.trim()"
                      circle
                    >
                      <el-icon><Promotion /></el-icon>
                    </el-button>
                  </div>
                </div>
                
                <!-- ËØ≠Èü≥ËæìÂÖ•Ê®°Âºè -->
                <div v-if="isVoiceInputMode" class="voice-input-panel">
                  <div class="voice-controls">
                    <button 
                      @click="toggleRecording" 
                      class="record-button"
                      :class="{ recording: isRecording }"
                    >
                      {{ isRecording ? 'üõë ÂÅúÊ≠¢ÂΩïÈü≥' : 'üé§ ÂºÄÂßãÂΩïÈü≥' }}
                    </button>
                    <div v-if="isRecording" class="recording-indicator">
                      <div class="recording-animation"></div>
                      <span>Ê≠£Âú®ÂΩïÈü≥‰∏≠...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ËØ≠Èü≥ËÅäÂ§©Ê†áÁ≠æÈ°µ -->
            <div v-show="chatMode === 'voice'" class="tab-content voice-chat-tab">
              <!-- ÂÆåÊï¥ÁöÑVoiceChatBoxÁªÑ‰ª∂ÔºåÂåÖÂê´Ëá™Â∑±ÁöÑÊ∂àÊÅØÊòæÁ§∫Âíå‰∫§‰∫í -->
              <VoiceChatBox 
                v-if="chatMode === 'voice'"
                :app-id="selectedApp.appId"
                :auto-connect="true"
                :prologue="selectedApp.prologue"
                :key="`voice-${selectedApp.appId}`"
                ref="voiceChatBoxRef"
                class="full-voice-chat"
                @message="handleVoiceMessage"
                @connectionChange="handleVoiceConnectionChange"
              />
            </div>
          </div>
        </div>

        <!-- Êú™ÈÄâÊã©Â∫îÁî®Áä∂ÊÄÅ -->
        <div v-else class="empty-chat">
          <el-empty description="ËØ∑ÈÄâÊã©‰∏Ä‰∏™Â∫îÁî®ÂºÄÂßãËÅäÂ§©">
            <el-button type="primary" @click="showCreateModal = true">
              ÂàõÂª∫Êñ∞Â∫îÁî®
            </el-button>
          </el-empty>
        </div>
      </el-main>
    </el-container>

    <!-- ÂàõÂª∫Â∫îÁî®ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="showCreateModal"
      title="ÂàõÂª∫Êñ∞Â∫îÁî®"
      width="600px"
      :before-close="handleCloseModal"
    >
      <el-form :model="newAppForm" :rules="formRules" ref="formRef" label-width="100px">
        <el-form-item label="Â∫îÁî®ÂêçÁß∞" prop="appName">
          <el-input v-model="newAppForm.appName" placeholder="ËØ∑ËæìÂÖ•Â∫îÁî®ÂêçÁß∞" />
        </el-form-item>
        
        <el-form-item label="Â∫îÁî®ÊèèËø∞" prop="description">
          <el-input
            v-model="newAppForm.description"
            type="textarea"
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•Â∫îÁî®ÊèèËø∞"
          />
        </el-form-item>
        
        <el-form-item label="ÂàùÂßãÂåñÊèêÁ§∫" prop="initPrompt">
          <el-input
            v-model="newAppForm.initPrompt"
            type="textarea"
            :rows="4"
            placeholder="ËØ∑ËæìÂÖ•Á≥ªÁªüÊèêÁ§∫ËØç"
          />
        </el-form-item>
        
        <el-form-item label="ÂºÄÂú∫ÁôΩ" prop="prologue">
          <el-input
            v-model="newAppForm.prologue"
            type="textarea"
            :rows="2"
            placeholder="ËØ∑ËæìÂÖ•ÂºÄÂú∫ÁôΩ"
          />
        </el-form-item>
        
        <el-form-item label="Â∞ÅÈù¢ÂõæÁâá">
          <el-input v-model="newAppForm.cover" placeholder="ËØ∑ËæìÂÖ•ÂõæÁâáURLÔºàÂèØÈÄâÔºâ" />
        </el-form-item>
      </el-form>
      
      <template #footer>
        <el-button @click="showCreateModal = false">ÂèñÊ∂à</el-button>
        <el-button type="primary" @click="createApp" :loading="createLoading">
          ÂàõÂª∫
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch, nextTick } from 'vue'
import { useRoute } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  ChatDotRound, Plus, Avatar, MoreFilled, User, Microphone,
  VideoPause, Promotion
} from '@element-plus/icons-vue'
import { useUserStore } from '@/stores'
import { getAppVoById, listMyAppVoByPage, createApp1, getOpeningRemark } from '@/api/appController'
import { listAppChatHistory } from '@/api/chatHistoryController'
import { chat } from '@/api/aiChatController'
import { SSEManager, chatService } from '@/services/chatService'
import VoiceChatBox from '@/components/VoiceChatBox.vue'
import type { AppDTO, AppVO } from '@/types/api'

// Ë∑ØÁî±ÂíåÁä∂ÊÄÅ
const route = useRoute()
const userStore = useUserStore()

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const apps = ref<AppVO[]>([])
const selectedApp = ref<AppVO | null>(null)
const messages = ref<any[]>([])
const inputMessage = ref('')
const isStreaming = ref(false)
const streamingContent = ref('')
const showCreateModal = ref(false)
const createLoading = ref(false)
const messagesContainer = ref<HTMLElement>()
const voiceMessagesContainer = ref<HTMLElement>()

// ËÅäÂ§©Ê®°Âºè
const chatMode = ref<'text' | 'voice'>('text')
const modeOptions = [
  { label: 'ÊñáÂ≠ó', value: 'text' },
  { label: 'ËØ≠Èü≥', value: 'voice' }
]

// ËØ≠Èü≥ËÅäÂ§©ÁªÑ‰ª∂ÂºïÁî®
const voiceChatBoxRef = ref<InstanceType<typeof VoiceChatBox>>()

// Ë°®ÂçïÊï∞ÊçÆ
const newAppForm = ref<AppDTO>({
  appName: '',
  description: '',
  initPrompt: '',
  prologue: '',
  cover: ''
})

const formRules = {
  appName: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Â∫îÁî®ÂêçÁß∞', trigger: 'blur' }
  ],
  description: [
    { required: true, message: 'ËØ∑ËæìÂÖ•Â∫îÁî®ÊèèËø∞', trigger: 'blur' }
  ]
}

const formRef = ref()

// SSEÁÆ°ÁêÜÂô®
const sseManager = new SSEManager()

// ÊñπÊ≥ï
const loadApps = async () => {
  try {
    const response = await listMyAppVoByPage({
      pageNum: 1,
      pageSize: 20,
      sortField: 'create_time',
      sortOrder: 'descend'
    })
    if (response.data?.code === 0) {
      apps.value = response.data?.data?.records || []
      
      // Â§ÑÁêÜË∑ØÁî±ÂèÇÊï∞ - ‰ºòÂÖàÂ§ÑÁêÜÊù•Ëá™Â∫îÁî®ÂπøÂú∫ÁöÑÂ∫îÁî®
      await handleRouteParams()
    }
  } catch (error) {
    ElMessage.error('Âä†ËΩΩÂ∫îÁî®ÂàóË°®Â§±Ë¥•')
  }
}

// Â§ÑÁêÜË∑ØÁî±ÂèÇÊï∞
const handleRouteParams = async () => {
  console.log('Â§ÑÁêÜË∑ØÁî±ÂèÇÊï∞:', route.query)
  
  if (route.query.appId) {
    // ‰ΩøÁî®Â≠óÁ¨¶‰∏≤Â§ÑÁêÜÂ§ßÊï¥Êï∞ÔºåÈÅøÂÖçJavaScriptÁ≤æÂ∫¶‰∏¢Â§±
    const appIdStr = route.query.appId as string
    const appId = BigInt(appIdStr) // ‰ΩøÁî®BigIntÂ§ÑÁêÜÂ§ßÊï¥Êï∞
    console.log('Ëß£ÊûêÁöÑappId:', appIdStr, '(BigInt:', appId.toString(), ')')
    
    // Áªü‰∏Ä‰ΩøÁî® API Ëé∑ÂèñÂ∫îÁî®ËØ¶ÊÉÖÔºåÁ°Æ‰øùÊï∞ÊçÆÂÆåÊï¥ÊÄß
    try {
      console.log('ÈÄöËøáAPIËé∑ÂèñÂ∫îÁî®ËØ¶ÊÉÖÔºåappId:', appIdStr)
      console.log('APIË∞ÉÁî®ÂèÇÊï∞:', { id: appIdStr }) // ‰º†ÈÄíÂ≠óÁ¨¶‰∏≤ËÄå‰∏çÊòØÊï∞Â≠ó
      
      const appResponse = await getAppVoById({ id: appIdStr })
      console.log('APIÂÆåÊï¥ÂìçÂ∫î:', appResponse)
      
      if (appResponse.data?.code === 0 && appResponse.data?.data) {
        const appData = appResponse.data.data
        console.log('Ëé∑ÂèñÂà∞ÁöÑÂ∫îÁî®Êï∞ÊçÆ:', appData)
        console.log('Â∫îÁî®IDÂåπÈÖçÊ£ÄÊü•:', appData.appId, '===', appIdStr, appData.appId == appIdStr)
        
        // È™åËØÅËøîÂõûÁöÑÂ∫îÁî®IDÊòØÂê¶ÂåπÈÖç - ‰ΩøÁî®Â≠óÁ¨¶‰∏≤ÊØîËæÉ
        if ((appData.appId || appData.id) == appIdStr) {
          // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®ËØ•Â∫îÁî®
          const existingAppIndex = apps.value.findIndex(app => app.appId == appIdStr)
          if (existingAppIndex >= 0) {
            // Êõ¥Êñ∞Áé∞ÊúâÂ∫îÁî®‰ø°ÊÅØ
            apps.value[existingAppIndex] = appData
          } else {
            // Ê∑ªÂä†Êñ∞Â∫îÁî®Âà∞ÂàóË°®È°∂ÈÉ®
            apps.value.unshift(appData)
          }
          
          selectApp(appData)
          ElMessage.success(`Â∑≤Âä†ËΩΩÂ∫îÁî®Ôºö${appData.appName}`)
        } else {
          console.error('APIËøîÂõûÁöÑÂ∫îÁî®ID‰∏çÂåπÈÖçÔºÅÊúüÊúõ:', appIdStr, 'ÂÆûÈôÖ:', appData.appId, 'Á±ªÂûã:', typeof appIdStr, typeof appData.appId)
          ElMessage.error(`Â∫îÁî®ID‰∏çÂåπÈÖçÔºåÊúüÊúõ: ${appIdStr}ÔºåÂÆûÈôÖ: ${appData.appId}`)
          
          // Â∞ùËØï‰ªéÁé∞ÊúâÂàóË°®‰∏≠Êü•ÊâæÊ≠£Á°ÆÁöÑÂ∫îÁî®
          const correctApp = apps.value.find(app => app.appId == appIdStr)
          if (correctApp) {
            selectApp(correctApp)
            ElMessage.success(`‰ªéÊú¨Âú∞ÂàóË°®Âä†ËΩΩÂ∫îÁî®Ôºö${correctApp.appName}`)
          } else {
            ElMessage.error('Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑÂ∫îÁî®')
          }
        }
      } else {
        console.error('APIËøîÂõûÈîôËØØ:', appResponse)
        ElMessage.error('Ëé∑ÂèñÂ∫îÁî®‰ø°ÊÅØÂ§±Ë¥•')
        // Â¶ÇÊûúAPIÂ§±Ë¥•ÔºåÂ∞ùËØï‰ªéÁé∞ÊúâÂàóË°®‰∏≠Êü•Êâæ
        selectAppById(appIdStr)
      }
    } catch (error) {
      console.error('Ëé∑ÂèñÂ∫îÁî®ËØ¶ÊÉÖÂ§±Ë¥•:', error)
      ElMessage.error('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÂ∫îÁî®‰ø°ÊÅØ')
      // Â¶ÇÊûúÁΩëÁªúÈîôËØØÔºåÂ∞ùËØï‰ªéÁé∞ÊúâÂàóË°®‰∏≠Êü•Êâæ
      selectAppById(appIdStr)
    }
  } else if (apps.value.length > 0) {
    selectApp(apps.value[0])
  }
}

const selectApp = async (app: AppVO) => {
  console.log('ÈÄâÊã©Â∫îÁî®:', app)
  selectedApp.value = app
  messages.value = []
  streamingContent.value = ''
  
  if (chatMode.value === 'text') {
    // ÊñáÂ≠óÊ®°ÂºèÂä†ËΩΩÂØπËØùÂéÜÂè≤
    await loadChatHistory(app.appId)
  } else if (chatMode.value === 'voice') {
    // ËØ≠Èü≥Ê®°ÂºèËÆ©VoiceChatBoxÂ§ÑÁêÜÂàùÂßãÂåñ
    console.log('ÈÄâÊã©Â∫îÁî®ÂêéÔºåËØ≠Èü≥Ê®°ÂºèÂàùÂßãÂåñVoiceChatBox')
    await nextTick(() => {
      if (voiceChatBoxRef.value) {
        voiceChatBoxRef.value.loadHistory?.()
      }
    })
  }
}

const selectAppById = (appId: string | number) => {
  const app = apps.value.find(app => app.appId == appId)
  if (app) {
    selectApp(app)
  }
}

const loadChatHistory = async (appId: string | number) => {
  console.log('üîÑ ÂºÄÂßãÂä†ËΩΩÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤ÔºåappId:', appId)
  try {
    // Ë∞ÉÁî®ËÅäÂ§©ÂéÜÂè≤API
    const response = await listAppChatHistory({ 
      appId: appId as any, 
      pageSize: 50 
    })
    
    console.log('üì• ÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤APIÂìçÂ∫î:', response)
    
    // Ëß£ÊûêÂìçÂ∫îÊï∞ÊçÆ
    const records = response?.data?.data?.history?.records ?? response?.data?.history?.records ?? []
    
    if (!records || records.length === 0) {
      console.log('üìù Ê≤°ÊúâÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤Êï∞ÊçÆÔºåÊ∏ÖÁ©∫Ê∂àÊÅØÂàóË°®')
      messages.value = []
      return
    }

    // Â§ÑÁêÜÂéÜÂè≤Êï∞ÊçÆÔºöÊåâÊó∂Èó¥ÊéíÂ∫èÔºåÂå∫ÂàÜAIÂíåÁî®Êà∑Ê∂àÊÅØ
    const chatMessages = records.map((item: any) => {
      const messageType = (item.messageType ?? item.type) as 'user' | 'ai'
      const content = item.message ?? item.content ?? ''
      const createTime = item.createTime ?? item.updateTime ?? item.timestamp
      
      // Â§ÑÁêÜÊó∂Èó¥Êà≥
      let timestamp: Date
      if (typeof createTime === 'string') {
        timestamp = new Date(createTime)
      } else if (createTime instanceof Date) {
        timestamp = createTime
      } else if (typeof createTime === 'number') {
        timestamp = new Date(createTime)
      } else {
        timestamp = new Date()
      }

      return {
        id: item.id ?? Date.now() + Math.random(),
        content: content,
        type: messageType,
        timestamp: timestamp
      }
    })

    // ÊåâÊó∂Èó¥ÊéíÂ∫èÔºà‰ªéÊó©Âà∞ÊôöÔºâ
    chatMessages.sort((a, b) => a.timestamp.getTime() - b.timestamp.getTime())
    
    messages.value = chatMessages
    console.log('‚úÖ ÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤Âä†ËΩΩÂÆåÊàêÔºåÂÖ±', messages.value.length, 'Êù°Ê∂àÊÅØ')
    
    await nextTick()
    scrollToBottom()
  } catch (error) {
    console.error('‚ùå Âä†ËΩΩÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error)
    messages.value = []
  }
}


const sendMessage = async () => {
  if (!inputMessage.value.trim() || !selectedApp.value || isStreaming.value) {
    return
  }

  const userMessage = inputMessage.value.trim()
  inputMessage.value = ''
  isStreaming.value = true
  streamingContent.value = ''

  // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
  messages.value.push({
    id: Date.now(),
    type: 'user',
    content: userMessage,
    timestamp: new Date()
  })

  scrollToBottom()

  try {
    // ÊûÑÂª∫SSEËØ∑Ê±ÇURL - ÂêéÁ´ØÁ´ØÂè£ÊòØ8123
    const sseUrl = `http://localhost:8123/api/chat/chat?appId=${selectedApp.value.appId}&message=${encodeURIComponent(userMessage)}`
    console.log('üöÄ ÂºÄÂßãSSEËÅäÂ§©ËØ∑Ê±Ç:', sseUrl)
    
    // ÂàõÂª∫EventSourceËøûÊé•
    const eventSource = new EventSource(sseUrl)
    
    // Â§ÑÁêÜSSEÊ∂àÊÅØ
    eventSource.onmessage = (event) => {
      try {
        console.log('üì• Êî∂Âà∞SSEÊï∞ÊçÆ:', event.data)
        
        // Ëß£Êûê {"d": "chunk"} Ê†ºÂºèÁöÑÊï∞ÊçÆ
        const parsedData = JSON.parse(event.data)
        if (parsedData && parsedData.d) {
          streamingContent.value += parsedData.d
          scrollToBottom()
        }
      } catch (error) {
        console.error('‚ùå Ëß£ÊûêSSEÊï∞ÊçÆÂ§±Ë¥•:', error, 'ÂéüÂßãÊï∞ÊçÆ:', event.data)
      }
    }
    
    // Â§ÑÁêÜÂÆåÊàê‰∫ã‰ª∂
    eventSource.addEventListener('done', () => {
      console.log('‚úÖ SSEÊµÅÂºèÂìçÂ∫îÂÆåÊàê')
      
      if (streamingContent.value) {
        messages.value.push({
          id: Date.now() + 1,
          type: 'ai',
          content: streamingContent.value,
          timestamp: new Date()
        })
        streamingContent.value = ''
      }
      
      isStreaming.value = false
      eventSource.close()
      scrollToBottom()
    })
    
    // Â§ÑÁêÜÈîôËØØ
    eventSource.onerror = (error) => {
      console.error('‚ùå SSEËøûÊé•ÈîôËØØ:', error)
      ElMessage.error('ËÅäÂ§©ËøûÊé•Â§±Ë¥•')
      isStreaming.value = false
      streamingContent.value = ''
      eventSource.close()
    }
    
  } catch (error) {
    console.error('‚ùå ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•:', error)
    ElMessage.error('ÂèëÈÄÅÊ∂àÊÅØÂ§±Ë¥•')
    isStreaming.value = false
  }
}

// ËØ≠Èü≥ËæìÂÖ•Áõ∏ÂÖ≥
const isVoiceInputMode = ref(false)
const isRecording = ref(false)

// ËØ≠Èü≥ËæìÂÖ•Áõ∏ÂÖ≥ÊñπÊ≥ï
const toggleVoiceInput = () => {
  isVoiceInputMode.value = !isVoiceInputMode.value
  if (!isVoiceInputMode.value && isRecording.value) {
    stopRecording()
  }
}

const toggleRecording = () => {
  if (isRecording.value) {
    stopRecording()
  } else {
    startRecording()
  }
}

const startRecording = () => {
  isRecording.value = true
  ElMessage.info('ÂºÄÂßãÂΩïÈü≥...')
  
  // Ê®°ÊãüÂΩïÈü≥ËøáÁ®ãÔºåÂÆûÈôÖÈ°πÁõÆ‰∏≠ÈúÄË¶ÅÈõÜÊàêËØ≠Èü≥ËØÜÂà´API
  setTimeout(() => {
    if (isRecording.value) {
      stopRecording()
      // Ê®°ÊãüËØ≠Èü≥ËΩ¨ÊñáÂ≠óÁªìÊûú
      inputMessage.value += 'ËøôÊòØËØ≠Èü≥ËΩ¨Êç¢ÁöÑÊñáÂ≠óÂÜÖÂÆπ'
    }
  }, 3000)
}

const stopRecording = () => {
  isRecording.value = false
  ElMessage.success('ÂΩïÈü≥ÁªìÊùü')
}

const createApp = async () => {
  if (!formRef.value) return
  
  const valid = await formRef.value.validate()
  if (!valid) return

  createLoading.value = true
  try {
    const response = await createApp1(newAppForm.value)
    if (response.data?.code === 0) {
      ElMessage.success('ÂàõÂª∫Â∫îÁî®ÊàêÂäü')
      showCreateModal.value = false
      resetForm()
      loadApps()
    }
  } catch (error) {
    ElMessage.error('ÂàõÂª∫Â∫îÁî®Â§±Ë¥•')
  } finally {
    createLoading.value = false
  }
}

const handleCloseModal = () => {
  showCreateModal.value = false
  resetForm()
}

const resetForm = () => {
  newAppForm.value = {
    appName: '',
    description: '',
    initPrompt: '',
    prologue: '',
    cover: ''
  }
  formRef.value?.resetFields()
}

const handleMenuCommand = async (command: string) => {
  switch (command) {
    case 'clear':
      try {
        await ElMessageBox.confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂΩìÂâçÂØπËØùÂêóÔºü', 'ÊèêÁ§∫', {
          confirmButtonText: 'Á°ÆÂÆö',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning'
        })
        messages.value = []
        ElMessage.success('ÂØπËØùÂ∑≤Ê∏ÖÁ©∫')
      } catch {
        // Áî®Êà∑ÂèñÊ∂à
      }
      break
    case 'export':
      exportChat()
      break
    case 'settings':
      ElMessage.info('ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...')
      break
  }
}

const exportChat = () => {
  if (!selectedApp.value || messages.value.length === 0) {
    ElMessage.warning('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÂØπËØù')
    return
  }

  const chatContent = messages.value.map(msg => 
    `${msg.type === 'user' ? 'Áî®Êà∑' : selectedApp.value?.appName}: ${msg.content}`
  ).join('\n\n')

  const blob = new Blob([chatContent], { type: 'text/plain' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${selectedApp.value.appName}-ÂØπËØùËÆ∞ÂΩï.txt`
  a.click()
  URL.revokeObjectURL(url)
}

const scrollToBottom = () => {
  nextTick(() => {
    // Âè™Â§ÑÁêÜÊñáÂ≠óËÅäÂ§©ÁöÑÊªöÂä®ÔºåËØ≠Èü≥ËÅäÂ§©Áî±VoiceChatBoxËá™Â∑±Â§ÑÁêÜ
    if (chatMode.value === 'text' && messagesContainer.value) {
      messagesContainer.value.scrollTop = messagesContainer.value.scrollHeight
    }
  })
}

const formatTime = (date: Date | string) => {
  if (!date) return ''
  const dateObj = typeof date === 'string' ? new Date(date) : date
  const now = new Date()
  const diff = now.getTime() - dateObj.getTime()
  
  if (diff < 60000) return 'ÂàöÂàö'
  if (diff < 3600000) return `${Math.floor(diff / 60000)}ÂàÜÈíüÂâç`
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}Â∞èÊó∂Ââç`
  if (diff < 604800000) return `${Math.floor(diff / 86400000)}Â§©Ââç`
  
  return dateObj.toLocaleDateString('zh-CN')
}

const formatMessageContent = (content: string) => {
  // ÁÆÄÂçïÁöÑmarkdownÊ∏≤Êüì
  return content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`(.*?)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>')
}

const getUnreadCount = (appId: string | number) => {
  // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞Êú™ËØªÊ∂àÊÅØËÆ°Êï∞ÈÄªËæë
  return 0
}

const handleShiftEnter = (event: KeyboardEvent) => {
  // Shift+Enter Êç¢Ë°å
  const target = event.target as HTMLTextAreaElement
  const start = target.selectionStart
  const end = target.selectionEnd
  inputMessage.value = inputMessage.value.substring(0, start) + '\n' + inputMessage.value.substring(end)
  nextTick(() => {
    target.selectionStart = target.selectionEnd = start + 1
  })
}

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
  loadApps()
})

// ÁõëÂê¨Ë∑ØÁî±ÂèòÂåñ
watch(() => route.query, (newQuery) => {
  if (newQuery.appId) {
    handleRouteParams()
  }
}, { deep: true })

// ÁõëÂê¨ËÅäÂ§©Ê®°ÂºèÂèòÂåñ
watch(chatMode, async (newMode, oldMode) => {
  console.log('ËÅäÂ§©Ê®°ÂºèÂèòÂåñ:', { newMode, oldMode, hasApp: !!selectedApp.value })
  
  if (newMode === 'text' && selectedApp.value) {
    // ÂàáÊç¢Âà∞ÊñáÂ≠óÊ®°ÂºèÊó∂Âä†ËΩΩÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤
    console.log('ÂàáÊç¢Âà∞ÊñáÂ≠óÊ®°ÂºèÔºåÂä†ËΩΩÊñáÂ≠óËÅäÂ§©ÂéÜÂè≤')
    await loadChatHistory(selectedApp.value.appId)
  } else if (newMode === 'voice' && selectedApp.value) {
    // ÂàáÊç¢Âà∞ËØ≠Èü≥Ê®°ÂºèÊó∂ÔºåVoiceChatBox‰ºöËá™Âä®Â§ÑÁêÜÂéÜÂè≤Âä†ËΩΩ
    console.log('ÂàáÊç¢Âà∞ËØ≠Èü≥Ê®°ÂºèÔºåVoiceChatBoxÂ∞ÜËá™Âä®Â§ÑÁêÜÂéÜÂè≤ÂíåÂºÄÂú∫ÁôΩ')
    await nextTick(() => {
      if (voiceChatBoxRef.value) {
        // Ë∞ÉÁî®VoiceChatBoxÁöÑÂéÜÂè≤Âä†ËΩΩÊñπÊ≥ï
        voiceChatBoxRef.value.loadHistory?.()
      }
    })
  }
})

// Â§ÑÁêÜËØ≠Èü≥Ê∂àÊÅØ‰∫ã‰ª∂
const handleVoiceMessage = (message: any) => {
  console.log('Êî∂Âà∞ËØ≠Èü≥Ê∂àÊÅØ:', message)
  // ËØ≠Èü≥Ê∂àÊÅØÁî±VoiceChatBoxËá™Â∑±Â§ÑÁêÜÔºåËøôÈáåÂè™ÂÅöÊó•ÂøóËÆ∞ÂΩï
}

// Â§ÑÁêÜËØ≠Èü≥ËøûÊé•Áä∂ÊÄÅÂèòÂåñ
const handleVoiceConnectionChange = (connected: boolean) => {
  console.log('ËØ≠Èü≥ËøûÊé•Áä∂ÊÄÅÂèòÂåñ:', connected)
  // ÂèØ‰ª•Âú®ËøôÈáåÊõ¥Êñ∞UIÁä∂ÊÄÅÊàñÊòæÁ§∫ËøûÊé•ÊèêÁ§∫
}

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜSSEËøûÊé•
onUnmounted(() => {
  sseManager.close()
})
</script>

<style scoped>
.chat-page {
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.chat-container {
  height: 100%;
  background: white;
  border-radius: 16px 16px 0 0;
  overflow: hidden;
  box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
}

/* ‰æßËæπÊ†èÊ†∑Âºè */
.chat-sidebar {
  background: #f8f9fa;
  border-right: 1px solid #e9ecef;
  display: flex;
  flex-direction: column;
}

.sidebar-header {
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-title h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
  color: #2c3e50;
}

.app-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.app-item {
  display: flex;
  align-items: center;
  padding: 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  margin-bottom: 4px;
}

.app-item:hover {
  background: rgba(102, 126, 234, 0.1);
}

.app-item.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.app-item.active .app-name,
.app-item.active .app-desc {
  color: white;
}

.app-avatar {
  flex-shrink: 0;
  margin-right: 12px;
}

.app-info {
  flex: 1;
  min-width: 0;
}

.app-name {
  font-size: 14px;
  font-weight: 600;
  margin: 0 0 4px 0;
  color: #2c3e50;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.app-desc {
  font-size: 12px;
  color: #6c757d;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.unread-badge {
  position: absolute;
  top: 8px;
  right: 8px;
}

/* ÂΩìÂâçAPP‰ø°ÊÅØÂå∫Âüü */
.current-app-info {
  padding: 16px;
  border-bottom: 1px solid #e9ecef;
  background: white;
  margin: 8px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.current-app-card {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
}

.current-app-avatar {
  flex-shrink: 0;
}

.current-app-details {
  flex: 1;
  min-width: 0;
}

.current-app-name {
  font-size: 16px;
  font-weight: 600;
  margin: 0 0 4px 0;
  color: #2c3e50;
}

.current-app-desc {
  font-size: 13px;
  color: #6c757d;
  margin: 0 0 8px 0;
  line-height: 1.4;
}

.app-meta {
  display: flex;
  align-items: center;
  gap: 8px;
}

.create-time {
  font-size: 11px;
  color: #999;
}

.welcome-message {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
  border: 1px solid rgba(102, 126, 234, 0.2);
  border-radius: 8px;
  padding: 12px;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.welcome-icon {
  color: #667eea;
  margin-top: 2px;
  flex-shrink: 0;
}

.welcome-message p {
  margin: 0;
  font-size: 13px;
  color: #4a5568;
  line-height: 1.4;
}

/* ‰∏ªËÅäÂ§©Âå∫Âüü */
.chat-main {
  padding: 0;
  display: flex;
  flex-direction: column;
}

.chat-content {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.app-details h3 {
  margin: 0 0 4px 0;
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
}

.app-details p {
  margin: 0;
  font-size: 12px;
  color: #6c757d;
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

/* ËÅäÂ§©Ê†áÁ≠æÈ°µÊ†∑Âºè */
.chat-tabs {
  background: white;
  border-bottom: 1px solid #e9ecef;
  padding: 0 24px;
}

.tabs-container {
  display: flex;
  gap: 0;
  max-width: 800px;
  margin: 0 auto;
}

.tab-button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 24px;
  border: none;
  background: transparent;
  color: #6c757d;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
  position: relative;
}

.tab-button:hover {
  color: #667eea;
  background: rgba(102, 126, 234, 0.05);
}

.tab-button.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: rgba(102, 126, 234, 0.08);
}

.tab-button.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 2px 2px 0 0;
}

/* Ê†áÁ≠æÈ°µÂÜÖÂÆπÂå∫Âüü */
.tab-content-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.tab-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.text-chat-tab {
  background: #f8f9fa;
}

.voice-chat-tab {
  background: #f8f9fa;
}

/* ËØ≠Èü≥ËÅäÂ§©Ê†áÁ≠æÈ°µÊ†∑Âºè */
.voice-chat-tab {
  background: #f8f9fa;
}

.full-voice-chat {
  height: 100%;
  width: 100%;
}

/* Ê∂àÊÅØÂå∫Âüü */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f8f9fa;
}

.messages-list {
  max-width: 800px;
  margin: 0 auto;
}

.message-item {
  margin-bottom: 16px;
}

.message-item.user {
  display: flex;
  justify-content: flex-end;
}

.message-item.ai {
  display: flex;
  justify-content: flex-start;
}

.message-bubble {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  max-width: 70%;
}

.user-message {
  flex-direction: row-reverse;
}

.ai-message {
  flex-direction: row;
}

.message-avatar {
  flex-shrink: 0;
}

.bubble-content {
  background: white;
  border-radius: 16px;
  padding: 12px 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  position: relative;
}

.user-message .bubble-content {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}

.message-text {
  font-size: 14px;
  line-height: 1.5;
  word-wrap: break-word;
}

.message-time {
  font-size: 11px;
  color: #999;
  margin-top: 4px;
  text-align: right;
}

.user-message .message-time {
  color: rgba(255, 255, 255, 0.7);
}

.streaming .bubble-content {
  border: 2px solid #667eea;
}

.typing-indicator {
  display: flex;
  gap: 4px;
  margin-top: 8px;
}

.typing-indicator span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #667eea;
  animation: typing 1.4s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

.welcome-message {
  margin-bottom: 24px;
}

/* ËæìÂÖ•Âå∫Âüü */
.text-input-area {
  padding: 16px 24px;
  background: white;
  border-top: 1px solid #e9ecef;
}

.input-container {
  max-width: 800px;
  margin: 0 auto;
}

.text-input {
  display: flex;
  align-items: flex-end;
  gap: 12px;
}

.message-input {
  flex: 1;
}

.input-actions {
  display: flex;
  align-items: center;
}

.voice-mode-container {
  width: 100%;
}

/* Á©∫Áä∂ÊÄÅ */
.empty-chat {
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .chat-container {
    border-radius: 0;
  }
  
  .chat-sidebar {
    width: 280px !important;
  }
  
  .chat-header {
    padding: 12px 16px;
  }
  
  .header-right {
    gap: 8px;
  }
  
  .chat-tabs {
    padding: 0 16px;
  }
  
  .tab-button {
    padding: 10px 16px;
    font-size: 13px;
  }
  
  .tab-button span {
    display: none;
  }
  
  .messages-container {
    padding: 16px;
  }
  
  .message-bubble {
    max-width: 85%;
  }
  
  .text-input-area {
    padding: 12px 16px;
  }
  
  /* ÁßªÂä®Á´ØËØ≠Èü≥ËÅäÂ§©Ê†áÁ≠æÈ°µË∞ÉÊï¥ */
  .voice-chat-tab {
    padding: 0;
  }
}

@media (max-width: 480px) {
  .chat-sidebar {
    width: 260px !important;
  }
  
  .app-item {
    padding: 8px;
  }
  
  .app-avatar {
    width: 32px !important;
    height: 32px !important;
  }
  
  .voice-btn {
    width: 56px;
    height: 56px;
  }
  
  /* Â∞èÂ±èÂπïËØ≠Èü≥ËÅäÂ§©Ê†áÁ≠æÈ°µË∞ÉÊï¥ */
  .voice-chat-tab {
    padding: 0;
  }
}
</style>